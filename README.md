# ファイルチャンカー（File Chunker）

大きなファイルを小さなチャンクに分割し、指数バックオフリトライロジックを使用してRESTful APIエンドポイントに送信するTypeScriptアプリケーションです。

## 特徴

- 設定可能なチャンクサイズで大きなファイルを分割
- チャンクをRESTful APIエンドポイントにアップロード
- ランダムなAPIエラーを指数バックオフリトライメカニズムで処理
- リアルタイムのアップロード進捗トラッキング
- サーバー側でのチャンク再結合
- Bootstrap UIを使用したモダンなReactフロントエンド
- TypeScriptで書かれたExpress.jsバックエンド

## アーキテクチャ

アプリケーションは2つの主要コンポーネントで構成されています。

1. フロントエンド

    - ファイル選択のためのユーザーインターフェースを提供し、ファイルの分割、チャンクのアップロード、進捗の追跡を処理するTypeScriptで構築されたReactアプリケーション。

2. バックエンド

    - ファイルチャンクを受信し、ランダムエラーをシミュレートし、すべてのチャンクがアップロードされたときに完全なファイルを再構築するTypeScriptで構築されたExpress.jsアプリケーション。

## 前提条件

- Node.js (v18以上)
- npm (v6以上)

## インストール

1. リポジトリをクローン

    ```bash
    git clone https://github.com/okamyuji/file-chunker.git
    cd file-chunker
    ```

2. 依存関係のインストール

    ```bash
    npm run install:all
    ```

このコマンドは、ルートプロジェクト、バックエンド、フロントエンドの依存関係をインストールします。

## 開発

開発モードでアプリケーションを実行するには、以下のコマンドをルートディレクトリで実行してください。

```bash
npm run dev
```

このコマンドは、ホットリロードを備えた開発モードでバックエンドとフロントエンドの両方を起動します。

- バックエンドは次のURLで利用可能になります：http://localhost:3001
- フロントエンドは次のURLで利用可能になります：http://localhost:3000

### バックエンドのみの実行

```bash
npm run dev:backend
```

### フロントエンドのみの実行

```bash
npm run dev:frontend
```

## プロダクション用のビルド

プロダクション用にバックエンドとフロントエンドの両方をビルドするには、以下のコマンドをルートディレクトリで実行してください。

```bash
npm run build
```

## 設定

### バックエンド設定

バックエンドの設定は `backend/src/config/default.ts` にあります。

```typescript
export default {
  server: {
    port: 3001,
  },
  upload: {
    tempDir: './temp',
    finalDir: './uploads',
  },
  api: {
    errorRate: 0.3, // テスト用：30%の確率でエラー発生
  },
};
```

- `port`: バックエンドサーバーのポート
- `tempDir`: 一時ファイルチャンクを保存するディレクトリ
- `finalDir`: 再結合されたファイルを保存するディレクトリ
- `errorRate`: ランダムエラーをシミュレートする確率 (0-1)

### フロントエンド設定

フロントエンドの設定は `frontend/src/config/index.ts` にあります。

```typescript
export const config = {
  api: {
    baseUrl: 'http://localhost:3001/api',
  },
  upload: {
    chunkSize: 1024 * 1024, // デフォルトで1MBチャンク
    maxRetries: 5,
    initialBackoff: 1000, // 1秒
    maxBackoff: 30000, // 30秒
  },
};
```

- `baseUrl`: バックエンドAPIのURL
- `chunkSize`: バイト単位の各ファイルチャンクのサイズ（デフォルト：1MB）
- `maxRetries`: 最大リトライ回数
- `initialBackoff`: ミリ秒単位の初期バックオフ時間
- `maxBackoff`: ミリ秒単位の最大バックオフ時間

## 仕組み

### フロントエンド

1. ユーザーがファイルと設定可能なチャンクサイズを選択
2. ファイルは設定されたサイズに基づいてチャンクに分割
3. チャンクは一つずつバックエンドAPIにアップロード
4. アップロードに失敗した場合、リトライする前に指数バックオフが適用
5. アップロードの進捗状況がユーザーに表示

### バックエンド

1. APIエンドポイントがファイルチャンクを受信
2. 設定されたエラー率に基づいてランダムエラーがシミュレート
3. 成功したチャンクは一時ディレクトリに保存
4. すべてのチャンクが受信されると、それらは完全なファイルに結合
5. 結合されたファイルはアップロードディレクトリに保存

### 指数バックオフ

APIリクエストが失敗した場合、フロントエンドは次の指数バックオフ戦略を実装します。

1. 初回リトライは短い遅延後に発生（デフォルト：1秒）
2. その後のリトライごとに遅延が2倍になる
3. サンダリングハード問題を防ぐためにランダムなジッターが追加
4. 遅延は最大値で制限（デフォルト：30秒）
5. 最大リトライ回数後、アップロードは失敗

## APIエンドポイント

### チャンクのアップロード

```bash
POST /api/upload/chunk
```

次のフォームデータを持つファイルチャンクを受け付けます。

- `originalFilename`: 元のファイル名
- `chunkIndex`: チャンクのインデックス（0ベース）
- `totalChunks`: チャンクの総数
- `chunk`: ファイルチャンクのバイナリデータ

レスポンス

- `200 OK`: チャンクが正常にアップロードされました
- `500 Internal Server Error`: ランダムサーバーエラー（リトライロジックのテスト用）

## ライセンス

MIT
